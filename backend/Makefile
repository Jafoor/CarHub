# ================================
# ğŸš— CarHub Backend Makefile
# ================================

# --- Configuration ---
APP_NAME=carhub
MAIN_FILE=main.go

DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=carhub
DB_HOST=localhost
DB_PORT=5432
DB_SSL=disable

MIGRATIONS_DIR=./migrations
DATABASE_URL=postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=${DB_SSL}

# --- Colors for logging ---
YELLOW=\033[1;33m
GREEN=\033[1;32m
RED=\033[1;31m
NC=\033[0m

# ================================
# ğŸ§± Build and Run
# ================================

build:
	@echo "$(YELLOW)ğŸš€ Building $(APP_NAME)...$(NC)"
	@go build -o bin/$(APP_NAME) $(MAIN_FILE)
	@echo "$(GREEN)âœ… Build complete.$(NC)"

run:
	@echo "$(YELLOW)ğŸƒ Running $(APP_NAME)...$(NC)"
	@go run $(MAIN_FILE)

dev:
	@echo "$(YELLOW)ğŸ”¥ Starting development server with Air...$(NC)"
	@air

clean:
	@echo "$(YELLOW)ğŸ§¹ Cleaning...$(NC)"
	@rm -rf bin
	@echo "$(GREEN)âœ… Cleaned.$(NC)"

# ================================
# ğŸ—„ï¸ Database Migrations
# ================================

migrate-up:
	@echo "$(YELLOW)ğŸ“¦ Running database migrations...$(NC)"
	@migrate -path $(MIGRATIONS_DIR) -database "$(DATABASE_URL)" up
	@echo "$(GREEN)âœ… Migrations applied.$(NC)"

migrate-down:
	@echo "$(YELLOW)âª Rolling back last migration...$(NC)"
	@migrate -path $(MIGRATIONS_DIR) -database "$(DATABASE_URL)" down 1
	@echo "$(GREEN)âœ… Rolled back.$(NC)"

migrate-force:
	@echo "$(YELLOW)âš™ï¸  Forcing migration version (use with care)...$(NC)"
	@migrate -path $(MIGRATIONS_DIR) -database "$(DATABASE_URL)" force $(version)

migrate-create:
	@if [ -z "$(name)" ]; then \
		echo "$(RED)âŒ Please specify migration name, e.g. make migrate-create name=create_users_table$(NC)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)ğŸ§© Creating migration: $(name)...$(NC)"
	@migrate create -ext sql -dir $(MIGRATIONS_DIR) -seq $(name)
	@echo "$(GREEN)âœ… Migration created.$(NC)"

# ================================
# ğŸ§ª Testing
# ================================

test:
	@echo "$(YELLOW)ğŸ§ª Running tests...$(NC)"
	@go test ./... -v
	@echo "$(GREEN)âœ… All tests passed.$(NC)"

# ================================
# ğŸ³ Docker Helpers (optional)
# ================================

docker-up:
	@echo "$(YELLOW)ğŸ³ Starting PostgreSQL container...$(NC)"
	@docker compose up -d db

docker-down:
	@echo "$(YELLOW)ğŸ›‘ Stopping PostgreSQL container...$(NC)"
	@docker compose down

# ================================
# ğŸ’¡ Utility
# ================================

help:
	@echo "Available commands:"
	@echo "  make build              - Build the app"
	@echo "  make run                - Run the app"
	@echo "  make clean              - Clean build artifacts"
	@echo "  make migrate-up         - Apply all migrations"
	@echo "  make migrate-down       - Rollback last migration"
	@echo "  make migrate-create name=<migration_name> - Create new migration"
	@echo "  make test               - Run tests"
	@echo "  make docker-up          - Start PostgreSQL in Docker"
	@echo "  make docker-down        - Stop PostgreSQL container"
